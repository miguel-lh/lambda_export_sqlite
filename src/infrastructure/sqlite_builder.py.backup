"""
Constructor de archivos SQLite.
Sigue el principio de Responsabilidad Única (SRP) de SOLID.
"""
import logging
import sqlite3
from typing import List, Optional

from src.domain.interfaces import ISQLiteBuilder
from src.domain.models import Cliente, Producto, ListaPrecio

logger = logging.getLogger(__name__)


class SQLiteBuilder(ISQLiteBuilder):
    """
    Constructor de bases de datos SQLite.
    Implementa ISQLiteBuilder siguiendo el principio DIP.
    """

    def __init__(self):
        """Inicializa el constructor SQLite."""
        self.connection: Optional[sqlite3.Connection] = None
        self.file_path: Optional[str] = None

    def create_database(self, file_path: str) -> None:
        """
        Crea una nueva base de datos SQLite.

        Args:
            file_path: Ruta donde crear el archivo SQLite
        """
        try:
            self.file_path = file_path
            self.connection = sqlite3.connect(file_path)
            logger.info(f"Base de datos SQLite creada: {file_path}")
        except sqlite3.Error as e:
            logger.error(f"Error creando base de datos SQLite: {e}")
            raise

    def create_schema(self) -> None:
        """Crea el esquema de tablas en la base de datos."""
        if not self.connection:
            raise RuntimeError("No hay conexión activa a SQLite")

        try:
            cursor = self.connection.cursor()

            # Tabla clientes
            cursor.execute("""
                CREATE TABLE IF NOT EXISTS Customer (
                    Id INTEGER PRIMARY KEY,
                    Slug TEXT,
                    Name TEXT,
                    Tel TEXT,
                    Email TEXT,
                    Code TEXT,
                    Sequence INTEGER,
                    Format TEXT,
                    TypeSale TEXT,
                    WayToPay TEXT,
                    Street TEXT,
                    ExtNumber TEXT,
                    IntNumber TEXT,
                    Suburb TEXT,
                    CodePostal TEXT,
                    City TEXT,
                    State TEXT,
                    Country TEXT,
                    Lat TEXT,
                    Lng TEXT,
                    Geofence TEXT,
                    SequenceTimesFrom1 LONG,
                    SequenceTimesUpTo1 LONG,
                    SequenceTimesFrom2 LONG,
                    SequenceTimesUpTo2 LONG,
                    SequenceTimesFrom3 LONG,
                    SequenceTimesUpTo3 LONG,
                    IsPaySun BOOLEAN,
                    IsPayMon BOOLEAN,
                    IsPayTues BOOLEAN,
                    IsPayWed BOOLEAN,
                    IsPayThurs BOOLEAN,
                    IsPayFri BOOLEAN,
                    IsPaySat BOOLEAN,
                    CodeNetsuit TEXT,
                    CreditLimit TEXT,
                    Checked BOOLEAN,
                    Deuda TEXT
                )
            """)

            # Tabla producto
            cursor.execute("""
                CREATE TABLE IF NOT EXISTS Product (
                    Id INTEGER PRIMARY KEY,
                    Sku TEXT,
                    Name TEXT,
                    Description INTEGER,
                    BardCode TEXT,
                    Type TEXT,
                    Brand TEXT,
                    Category TEXT,
                )
            """)

            # Tabla Cuentas bancarias
            cursor.execute("""
                CREATE TABLE IF NOT EXISTS Product (
                    Id INTEGER PRIMARY KEY,
                    Name TEXT,
                    BankName TEXT,
                    Number TEXT,
                    AccountingAccountName TEXT,
                )
            """)

            # Tabla listas_precios
            cursor.execute("""
                CREATE TABLE IF NOT EXISTS ListPrice (
                    Id INTEGER PRIMARY KEY,
                    Name TEXT,
                    Max TEXT,
                    Min TEXT,
                    CustomerSync INTEGER,
                )
            """)

            # Tabla Productos - Lista de precios
            cursor.execute("""
                CREATE TABLE IF NOT EXISTS ListPriceDetail (
                    Id INTEGER PRIMARY KEY,
                    IdPriceList INTEGER,
                    IdProduct INTEGER,
                    Price TEXT,
                    FOREIGN KEY (IdProduct) REFERENCES Product (Id),
                    FOREIGN KEY (IdPriceList) REFERENCES ListPrice (Id)
                )
            """)

            # Tabla Clientes - Lista de precios
            cursor.execute("""
                CREATE TABLE IF NOT EXISTS ClientListPrice (
                    Id INTEGER PRIMARY KEY,
                    IdClient INTEGER,
                    IdListPrice INTEGER,
                    FOREIGN KEY (IdListPrice) REFERENCES ListPrice (Id),
                    FOREIGN KEY (IdClient) REFERENCES Customer (Id)
                )
            """)

            # Tabla Ubicaciones
            cursor.execute("""
                CREATE TABLE IF NOT EXISTS Location (
                    Id INTEGER PRIMARY KEY,
                    Slug TEXT,
                    Name TEXT,
                    Tel TEXT,
                    Email TEXT,
                    Code TEXT,
                    Sequence INTEGER,
                    Format TEXT,
                    Zone TEXT,
                    Use TEXT,
                    Category TEXT,
                    TypeLocation TEXT,
                    Street TEXT,
                    ExtNumber TEXT,
                    IntNumber TEXT,
                    Suburb TEXT,
                    CodePostal TEXT,
                    City TEXT,
                    State TEXT,
                    Country TEXT,
                    Lat TEXT,
                    Lng TEXT,
                    Geofence TEXT,
                    SequenceTimesFrom1 LONG,
                    SequenceTimesUpTo1 LONG,
                    SequenceTimesFrom2 LONG,
                    SequenceTimesUpTo2 LONG,
                    SequenceTimesFrom3 LONG,
                    SequenceTimesUpTo3 LONG,
                    IsPaySun BOOLEAN,
                    IsPayMon BOOLEAN,
                    IsPayTues BOOLEAN,
                    IsPayWed BOOLEAN,
                    IsPayThurs BOOLEAN,
                    IsPayFri BOOLEAN,
                    IsPaySat BOOLEAN,
                    Seller TEXT,
                    Checked BOOLEAN
                )
            """)

            # Tabla Cobranza
            cursor.execute("""
                CREATE TABLE IF NOT EXISTS Cobranza (
                    Id INTEGER PRIMARY KEY,
                    IdClient INTEGER,
                    BillNumber TEXT,
                    Total TEXT,
                    Issue TEXT,
                    Validity TEXT
                    FOREIGN KEY (IdClient) REFERENCES Customer (Id)
                )
            """)

            # Tabla Detalle de cobranza
            cursor.execute("""
                CREATE TABLE IF NOT EXISTS CobranzaDetail (
                    Id INTEGER PRIMARY KEY,
                    IdCobranza INTEGER,
                    IdProduct INTEGER,
                    Amount TEXT,
                    Price TEXT,
                    FOREIGN KEY (IdCobranza) REFERENCES Cobranza (Id),
                    FOREIGN KEY (IdProduct) REFERENCES Product (Id)
                )
            """)
            
            
            # Crear índices para mejorar rendimiento
            # cursor.execute("CREATE INDEX IF NOT EXISTS idx_clientes_tenant ON clientes(tenant_id)")
            # cursor.execute("CREATE INDEX IF NOT EXISTS idx_producto_tenant ON producto(tenant_id)")
            # cursor.execute("CREATE INDEX IF NOT EXISTS idx_listas_tenant ON listas_precios(tenant_id)")
            # cursor.execute("CREATE INDEX IF NOT EXISTS idx_listas_producto ON listas_precios(producto_id)")
            # cursor.execute("CREATE INDEX IF NOT EXISTS idx_listas_cliente ON listas_precios(cliente_id)")

            self.connection.commit()
            logger.info("Esquema de base de datos creado exitosamente")

        except sqlite3.Error as e:
            logger.error(f"Error creando esquema: {e}")
            raise

    def insert_clientes(self, clientes: List[Cliente]) -> int:
        """
        Inserta clientes en la base de datos.

        Args:
            clientes: Lista de clientes a insertar

        Returns:
            Número de registros insertados
        """
        if not self.connection:
            raise RuntimeError("No hay conexión activa a SQLite")

        if not clientes:
            logger.warning("No hay clientes para insertar")
            return 0

        try:
            cursor = self.connection.cursor()

            for cliente in clientes:
                cursor.execute("""
                    INSERT INTO clientes (
                        id, tenant_id, codigo, nombre, email, telefono,
                        direccion, activo, fecha_creacion, fecha_actualizacion
                    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                """, (
                    cliente.id,
                    cliente.tenant_id,
                    cliente.codigo,
                    cliente.nombre,
                    cliente.email,
                    cliente.telefono,
                    cliente.direccion,
                    1 if cliente.activo else 0,
                    cliente.fecha_creacion.isoformat() if cliente.fecha_creacion else None,
                    cliente.fecha_actualizacion.isoformat() if cliente.fecha_actualizacion else None
                ))

            self.connection.commit()
            count = len(clientes)
            logger.info(f"Insertados {count} clientes")
            return count

        except sqlite3.Error as e:
            logger.error(f"Error insertando clientes: {e}")
            self.connection.rollback()
            raise

    def insert_productos(self, productos: List[Producto]) -> int:
        """
        Inserta productos en la base de datos.

        Args:
            productos: Lista de productos a insertar

        Returns:
            Número de registros insertados
        """
        if not self.connection:
            raise RuntimeError("No hay conexión activa a SQLite")

        if not productos:
            logger.warning("No hay productos para insertar")
            return 0

        try:
            cursor = self.connection.cursor()

            for producto in productos:
                cursor.execute("""
                    INSERT INTO producto (
                        id, tenant_id, codigo, nombre, descripcion, categoria,
                        unidad_medida, precio_base, activo, fecha_creacion, fecha_actualizacion
                    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                """, (
                    producto.id,
                    producto.tenant_id,
                    producto.codigo,
                    producto.nombre,
                    producto.descripcion,
                    producto.categoria,
                    producto.unidad_medida,
                    float(producto.precio_base),
                    1 if producto.activo else 0,
                    producto.fecha_creacion.isoformat() if producto.fecha_creacion else None,
                    producto.fecha_actualizacion.isoformat() if producto.fecha_actualizacion else None
                ))

            self.connection.commit()
            count = len(productos)
            logger.info(f"Insertados {count} productos")
            return count

        except sqlite3.Error as e:
            logger.error(f"Error insertando productos: {e}")
            self.connection.rollback()
            raise

    def insert_listas_precios(self, listas_precios: List[ListaPrecio]) -> int:
        """
        Inserta listas de precios en la base de datos.

        Args:
            listas_precios: Lista de listas de precios a insertar

        Returns:
            Número de registros insertados
        """
        if not self.connection:
            raise RuntimeError("No hay conexión activa a SQLite")

        if not listas_precios:
            logger.warning("No hay listas de precios para insertar")
            return 0

        try:
            cursor = self.connection.cursor()

            for lista in listas_precios:
                cursor.execute("""
                    INSERT INTO listas_precios (
                        id, tenant_id, producto_id, cliente_id, precio, moneda,
                        fecha_inicio, fecha_fin, activo, fecha_creacion, fecha_actualizacion
                    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                """, (
                    lista.id,
                    lista.tenant_id,
                    lista.producto_id,
                    lista.cliente_id,
                    float(lista.precio),
                    lista.moneda,
                    lista.fecha_inicio.isoformat() if lista.fecha_inicio else None,
                    lista.fecha_fin.isoformat() if lista.fecha_fin else None,
                    1 if lista.activo else 0,
                    lista.fecha_creacion.isoformat() if lista.fecha_creacion else None,
                    lista.fecha_actualizacion.isoformat() if lista.fecha_actualizacion else None
                ))

            self.connection.commit()
            count = len(listas_precios)
            logger.info(f"Insertadas {count} listas de precios")
            return count

        except sqlite3.Error as e:
            logger.error(f"Error insertando listas de precios: {e}")
            self.connection.rollback()
            raise

    def close(self) -> None:
        """Cierra la conexión con la base de datos SQLite."""
        if self.connection:
            self.connection.close()
            logger.info("Conexión SQLite cerrada")
